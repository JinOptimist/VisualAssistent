# Техническое задание: Боевая система

## Обзор

Боевая система является одной из ключевых механик игры, обеспечивающей динамичные сражения между игроком и противниками. Система построена на пошаговой механике с элементами стратегического планирования.

## Архитектура

### Файловая структура

- **`game/systems/battle_system.rpy`** - Вся логика боя, функции, переменные и обработчики
- **`game/script.rpy`** - Сценарии игры, только вызовы `start_battle()` и переходы
- **`game/screens.rpy`** - Интерфейс боя
- **`tests/test_battle_renpy.py`** - Тесты боевой логики

### Принципы разделения

- Вся боевая логика в `battle_system.rpy`
- Сценарии только вызывают бой с указанием противника
- Интерфейс отображает состояние из `battle_system.rpy`
- Тесты копируют логику из `battle_system.rpy`

### Класс BattleSystem

```python
class BattleSystem:
    def __init__(self):
        # Инициализация боевых переменных
        # Словарь противников
        # Настройки боя
```

## Переменные и компоненты

### Переменные игрока

- **player_hp**: Текущие очки здоровья игрока (изначально 10)
- **player_max_hp**: Максимальные очки здоровья игрока (изначально 10)
- **player_mp**: Текущие очки маны игрока (изначально 10)
- **player_max_mp**: Максимальные очки маны игрока (изначально 10)
- **player_shield**: Количество щитов у игрока (изначально 0)
- **player_defending**: Флаг, отражающий, что игрок в режиме защиты (изначально False)
- **player_blood_overflow**: Флаг статуса "Переполнение кровью" (изначально False)
- **player_mana_overflow**: Флаг статуса "Переполнение маной" (изначально False)

### Переменные противника

- **enemy_name**: Имя противника (настраивается через start_battle)
- **enemy_hp**: Текущие очки здоровья противника
- **enemy_max_hp**: Максимальные очки здоровья противника
- **enemy_mp**: Текущие очки маны противника
- **enemy_max_mp**: Максимальные очки маны противника
- **enemy_shield**: Количество щитов у противника (изначально 0)
- **enemy_blood_overflow**: Флаг статуса "Переполнение кровью" (изначально False)
- **enemy_mana_overflow**: Флаг статуса "Переполнение маной" (изначально False)

## Механики боя

### 1. Система здоровья и маны

#### Здоровье (HP)

- **Базовое значение**: 10
- **Максимум**: 10 (увеличивается с уровнем)
- **Восстановление**: Зелья, заклинания, отдых
- **Потеря**: Атаки противника, эффекты переполнения

#### Мана (MP)

- **Базовое значение**: 10
- **Максимум**: 10 (увеличивается с интеллектом)
- **Восстановление**: Зелья, отдых
- **Расход**: Атаки, заклинания, защита

### 2. Система атак

#### Атака игрока

```python
def player_attack():
    # Требует 1 MP
    # Базовый урон: 1
    # Щит противника блокирует урон
    # Возвращает сообщение о результате
```

**Условия:**

- Наличие маны (≥ 1 MP)
- Противник жив (HP > 0)

**Механика:**

1. Проверка маны
2. Расчет урона
3. Проверка щита противника
4. Применение урона
5. Расход маны

**Действие**: Тратит 1 ману, наносит 1 урон противнику. Если у противника есть щит, щит поглощает урон и разрушается. Если HP противника уже 0 или меньше, атака невозможна.

#### Атака противника

```python
def enemy_turn():
    # ИИ выбирает действие
    # Возможные действия: атака, защита, лечение
    # Возвращает сообщение о результате
```

**ИИ противника:**

- Противник случайным образом выбирает действие: атака, создание щита или лечение (если есть мана)
- **Атака**: Тратит 1 ману, наносит 1 урон игроку. Если у игрока есть щит или активна защита, урон блокируется
- **Создание щита**: Тратит 1 ману, добавляет 1 щит противнику
- **Лечение**: Тратит 2 маны, восстанавливает 2 здоровья противнику
- Если у противника нет маны, он пропускает ход

### 3. Система защиты

#### Щит

- **Создание**: Заклинание щита (1 MP)
- **Эффект**: Блокирует 1 атаку
- **Максимум**: Нет ограничений
- **Снижение**: Атаки противника

**Действие**: `player_shield_spell()` - тратит 1 ману, добавляет 1 щит игроку

#### Защита

- **Активация**: Заклинание защиты (1 MP)
- **Эффект**: Блокирует следующую атаку
- **Длительность**: 1 ход

**Действие**: `player_defend()` - тратит 1 ману, активирует режим защиты (player_defending = True)

### 4. Система лечения

#### Лечение игрока

```python
def player_heal():
    # Требует 2 MP
    # Восстанавливает 2 HP
    # Может вызвать переполнение кровью
```

**Действие**: Тратит 2 маны, восстанавливает 2 здоровья игроку. Если текущее здоровье превышает максимальное, накладывается статус "Переполнение кровью"

### 5. Система переполнения

#### Переполнение кровью (Blood Overflow)

- **Условие активации**: Текущее здоровье > Максимальное здоровье
- **Эффект**: Каждый ход персонаж теряет 1 единицу здоровья и 2 единицы маны
- **Условие снятия**: Статус снимается, когда текущее здоровье становится меньше или равно максимальному

#### Переполнение маной (Mana Overflow)

- **Условие активации**: Текущая мана > Максимальная мана
- **Эффект**: Каждый ход персонаж теряет 1 единицу здоровья и 2 единицы маны
- **Условие снятия**: Статус снимается, когда текущая мана становится меньше или равна максимальной

#### Приоритет статусов

- Если персонаж имеет оба статуса одновременно, эффекты суммируются (потеря 2 здоровья и 4 маны за ход)
- Статусы проверяются и применяются в начале каждого хода персонажа
- Статусы проверяются и снимаются после каждого изменения здоровья/маны

## Противники

### 1. Гоблин (goblin)

```python
{
    "name": "Гоблин",
    "hp": 5,
    "max_hp": 5,
    "mp": 3,
    "max_mp": 3,
    "attack": 1,
    "defense": 0
}
```

**Характеристики:**

- Слабый, но быстрый
- Часто атакует
- Низкое здоровье

### 2. Орк (orc)

```python
{
    "name": "Орк",
    "hp": 8,
    "max_hp": 8,
    "mp": 2,
    "max_mp": 2,
    "attack": 2,
    "defense": 1
}
```

**Характеристики:**

- Сбалансированный противник
- Среднее здоровье и мана
- Использует различные тактики

### 3. Тролль (troll)

```python
{
    "name": "Тролль",
    "hp": 12,
    "max_hp": 12,
    "mp": 1,
    "max_mp": 1,
    "attack": 3,
    "defense": 2
}
```

**Характеристики:**

- Очень выносливый
- Высокий урон
- Мало маны

## Боевой цикл

### 1. Инициализация боя

```python
def start_battle(enemy_type="goblin"):
    # Установка противника
    # Сброс переменных
    # Начало боя
```

### 2. Основной цикл

1. **Применение эффектов статусов переполнения** (если есть)
2. **Отображение статуса**
   - HP/MP игрока и противника
   - Щиты
   - Статусы
3. **Выбор действия игрока**
   - Атака
   - Защита
   - Лечение
   - Использование предметов
4. **Выполнение действия игрока**, вывод результата
5. **Проверка и обновление статусов переполнения**
6. **Проверка условий окончания боя**
7. **Применение эффектов статусов переполнения противника**
8. **Ход противника**, вывод результата
9. **Проверка и обновление статусов переполнения противника**
10. **Проверка условий окончания боя**
11. Если бой не завершен — переход к следующему ходу

### 3. Завершение боя

```python
def is_battle_over():
    # Проверка HP игрока и противника
    # Возврат результата: victory/defeat/ongoing
```

## Логика боя

- Бой продолжается, пока у игрока и противника есть здоровье и мана
- **Победа игрока**: enemy_hp <= 0
- **Победа противника**: player_hp <= 0
- **Ничья**: у обоих закончилась мана, но никто не победил
- **Нельзя атаковать противника, если его HP уже 0 или меньше**
- Статусы переполнения применяются в начале каждого хода перед выполнением действий

## Функции

### Управление боем

- **start_battle(enemy_type)** — инициализирует бой с указанным типом противника ("goblin", "orc", "troll")
- **reset_battle()** — сбрасывает все переменные боя к начальному состоянию
- **is_battle_over()** — проверяет условия окончания боя
- **get_battle_result()** — возвращает результат боя

### Действия игрока

- **player_attack()** — реализует атаку игрока. Если HP противника <= 0, возвращает сообщение "Противник уже побежден!" и не изменяет HP
- **player_defend()** — реализует защиту игрока
- **player_shield_spell()** — реализует создание щита игроком
- **player_heal()** — реализует лечение игрока с проверкой переполнения здоровья

### Действия противника

- **enemy_turn()** — реализует ход противника

### Управление статусами

- **apply_overflow_effects(character)** — применяет эффекты статусов переполнения к указанному персонажу
- **check_overflow_status(character)** — проверяет и обновляет статусы переполнения персонажа
- **add_mana(character, amount)** — добавляет ману персонажу с проверкой переполнения маны
- **add_health(character, amount)** — добавляет здоровье персонажу с проверкой переполнения здоровья

## Обработчики действий (Ren'Py)

- Для каждого действия игрока есть отдельный label, который вызывает соответствующую функцию, выводит результат и передает ход противнику
- После каждого действия и хода противника проверяются условия окончания боя
- В начале каждого хода применяются эффекты статусов переполнения

## Использование в сценариях

### Пример вызова боя с гоблином:

```renpy
label battle_scene:
    python:
        start_battle("goblin")
    scene bg BG
    "Вы попадаете на поле боя!"
    "Перед вами появляется [enemy_name]!"
    jump battle_loop
```

### Пример вызова боя с орком:

```renpy
label battle_scene_orc:
    python:
        start_battle("orc")
    scene bg BG
    "Вы попадаете на поле боя!"
    "Перед вами появляется [enemy_name]!"
    jump battle_loop
```

## Результаты боя

### Победа

- Получение опыта (20-50 в зависимости от противника)
- Получение золота (10-30 в зависимости от противника)
- Улучшение навыка "Владение мечом" (+1-3 опыта)
- Разблокировка достижений

### Поражение

- Потеря репутации (-1)
- Возможность повторить бой
- Сохранение прогресса

### Ничья

- Оба участника без маны
- Считается поражением

## Интеграция с другими системами

### С системой прокачки

- Победа дает опыт
- Улучшает навык "Владение мечом"
- Разблокирует достижения

### С системой инвентаря

- Использование зелий в бою
- Экипировка влияет на характеристики
- Получение предметов после победы

### С системой соблазнения

- Репутация влияет на доступ к некоторым боям
- Победы повышают репутацию

## API системы

### Основные методы

#### Управление боем

```python
start_battle(enemy_type)     # Начать бой
reset_battle()               # Сбросить бой
is_battle_over()             # Проверить окончание
get_battle_result()          # Получить результат
```

#### Действия игрока

```python
player_attack()              # Атака
player_defend()              # Защита
add_health(character, amount) # Лечение
add_mana(character, amount)   # Восстановление маны
```

#### Управление статусами

```python
apply_overflow_effects(character) # Применить эффекты
check_overflow_status(character)  # Проверить статусы
```

### Доступ к данным

```python
battle_system.player_hp      # HP игрока
battle_system.enemy_name     # Имя противника
battle_system.enemies        # Словарь противников
```

## Баланс и настройки

### Базовые значения

- **Здоровье игрока**: 10
- **Мана игрока**: 10
- **Стоимость атаки**: 1 MP
- **Стоимость защиты**: 1 MP
- **Стоимость лечения**: 2 MP
- **Урон атаки**: 1
- **Лечение**: 2 HP

### Модификаторы

- **Сила**: +0.5 к урону за очко
- **Интеллект**: +1.5 к максимальной мане за очко
- **Живучесть**: +2 к максимальному здоровью за очко

## Отображение информации

- В интерфейсе отображается текущее и максимальное здоровье/мана в формате "Текущее/Максимальное"
- Статусы переполнения отображаются как иконки или текстовые индикаторы
- При активации/снятии статуса выводится соответствующее сообщение

## Планы развития

### Краткосрочные цели

- [ ] Добавление новых противников
- [ ] Система критических ударов
- [ ] Элементальные атаки
- [ ] Система комбо

### Долгосрочные цели

- [ ] Многопользовательские бои
- [ ] Система гильдий
- [ ] Турниры и арены
- [ ] PvP режим

## Тестирование

### Тестовые сценарии

1. **Базовый бой**: Игрок против гоблина
2. **Сложный бой**: Игрок против тролля
3. **Длинный бой**: Проверка системы переполнения
4. **Использование предметов**: Зелья в бою
5. **Побег из боя**: Механика побега

### Метрики баланса

- Среднее время боя: 3-5 ходов
- Шанс победы: 60-80%
- Использование предметов: 20-30% боев
- Разнообразие тактик: Все действия должны быть полезны

### Конкретные тесты

- Проверка, что нельзя атаковать противника с HP <= 0 (test_no_attack_on_dead_enemy)
- Проверка, что после первой атаки HP противника становится 0, а повторная атака невозможна (test_battle_ends_when_enemy_hp_zero)
- Тесты для проверки механики переполнения здоровья и маны
- Тесты для проверки корректного применения и снятия статусов переполнения
- Тесты для проверки функции start_battle с разными типами противников

## Заключение

Боевая система обеспечивает динамичный и сбалансированный игровой процесс. Модульная архитектура позволяет легко добавлять новых противников и механики, сохраняя при этом баланс игры. Система включает все необходимые компоненты для полноценного боевого опыта с возможностью расширения в будущем.
