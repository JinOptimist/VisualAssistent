# Боевая система - Тестирование

## Обзор тестирования

Тестирование боевой системы обеспечивает корректность работы всех механик и баланс игры. Все тесты должны быть написаны в файле `tests/test_battle_renpy.py` и копировать логику из `game/systems/battle_system.rpy`.

## Ключевые тесты

### 1. Базовые механики

- Атаки (снарядом и потоком)
- Защита и щиты
- Лечение
- Управление маной и здоровьем

### 2. Статусы переполнения

- Активация статусов
- Применение эффектов
- Автоматическое снятие
- Суммирование эффектов

### 3. "Атака Потоком"

- Активация статуса
- Длительность (3 хода)
- Автоматический урон
- Ограничения действий
- Корректное снятие

### 4. Условия боя

- Победа игрока
- Победа противника
- Ничья
- Невозможность атаки мертвого противника

### 5. Противники

- Разные типы противников
- ИИ противника
- Баланс характеристик

## Конкретные тесты

### Тесты базовых механик

#### test_player_projectile_attack_basic

- **Цель**: Проверка базовой атаки снарядом
- **Предусловия**: Игрок имеет 1+ MP, противник жив
- **Действия**: Вызов player_projectile_attack()
- **Ожидаемый результат**: Противник получает 1 урон, игрок тратит 1 MP

#### test_player_projectile_attack_no_mana

- **Цель**: Проверка невозможности атаки без маны
- **Предусловия**: Игрок имеет 0 MP
- **Действия**: Вызов player_projectile_attack()
- **Ожидаемый результат**: Атака невозможна, возвращается сообщение об ошибке

#### test_player_projectile_attack_dead_enemy

- **Цель**: Проверка невозможности атаки мертвого противника
- **Предусловия**: HP противника ≤ 0
- **Действия**: Вызов player_projectile_attack()
- **Ожидаемый результат**: Возвращается "Противник уже побежден!", HP не изменяется

#### test_player_shield_spell

- **Цель**: Проверка создания щита
- **Предусловия**: Игрок имеет 1+ MP
- **Действия**: Вызов player_shield_spell()
- **Ожидаемый результат**: Игрок получает +1 щит, тратит 1 MP

#### test_player_defend

- **Цель**: Проверка активации защиты
- **Предусловия**: Игрок имеет 1+ MP
- **Действия**: Вызов player_defend()
- **Ожидаемый результат**: player_defending = True, тратит 1 MP

#### test_player_heal

- **Цель**: Проверка лечения
- **Предусловия**: Игрок имеет 2+ MP
- **Действия**: Вызов player_heal()
- **Ожидаемый результат**: Игрок получает +2 HP, тратит 2 MP

### Тесты статусов переполнения

#### test_blood_overflow_activation

- **Цель**: Проверка активации переполнения кровью
- **Предусловия**: HP игрока > max_HP
- **Действия**: Вызов check_overflow_status("player")
- **Ожидаемый результат**: player_blood_overflow = True

#### test_mana_overflow_activation

- **Цель**: Проверка активации переполнения маной
- **Предусловия**: MP игрока > max_MP
- **Действия**: Вызов check_overflow_status("player")
- **Ожидаемый результат**: player_mana_overflow = True

#### test_overflow_effects_application

- **Цель**: Проверка применения эффектов переполнения
- **Предусловия**: player_blood_overflow = True
- **Действия**: Вызов apply_overflow_effects("player")
- **Ожидаемый результат**: Игрок теряет 1 HP и теряет 2 MP

#### test_overflow_effects_combined

- **Цель**: Проверка суммирования эффектов переполнения
- **Предусловия**: player_blood_overflow = True, player_mana_overflow = True
- **Действия**: Вызов apply_overflow_effects("player")
- **Ожидаемый результат**: Игрок теряет 2 HP и теряет 4 MP

#### test_overflow_deactivation

- **Цель**: Проверка снятия статусов переполнения
- **Предусловия**: player_blood_overflow = True, HP ≤ max_HP
- **Действия**: Вызов check_overflow_status("player")
- **Ожидаемый результат**: player_blood_overflow = False

### Тесты "Атака Потоком"

#### test_stream_attack_activation

- **Цель**: Проверка активации "Атаки Потоком"
- **Предусловия**: Игрок имеет 2+ MP, не под эффектом
- **Действия**: Вызов player_stream_attack()
- **Ожидаемый результат**: player_stream_attack_is_active = True, turns = 3, тратит 2 MP

#### test_stream_attack_already_active

- **Цель**: Проверка невозможности повторной активации
- **Предусловия**: player_stream_attack_is_active = True
- **Действия**: Вызов player_stream_attack()
- **Ожидаемый результат**: Атака невозможна, возвращается сообщение об ошибке

#### test_stream_attack_effect_application

- **Цель**: Проверка применения эффекта "Атака Потоком"
- **Предусловия**: player_stream_attack_is_active = True, turns = 3
- **Действия**: Вызов apply_stream_attack_effect("player")
- **Ожидаемый результат**: Противник получает 1 урон, turns = 2

#### test_stream_attack_deactivation

- **Цель**: Проверка снятия статуса после 3 ходов
- **Предусловия**: player_stream_attack_is_active = True, turns = 1
- **Действия**: Вызов apply_stream_attack_effect("player")
- **Ожидаемый результат**: turns = 0, player_stream_attack_is_active = False

#### test_stream_attack_with_shield

- **Цель**: Проверка взаимодействия с щитом противника
- **Предусловия**: player_stream_attack_is_active = True, enemy_shield = 1
- **Действия**: Вызов apply_stream_attack_effect("player")
- **Ожидаемый результат**: Щит блокирует урон, enemy_shield = 0

### Тесты условий боя

#### test_battle_victory_player

- **Цель**: Проверка победы игрока
- **Предусловия**: enemy_hp = 1
- **Действия**: Вызов player_projectile_attack()
- **Ожидаемый результат**: enemy_hp = 0, is_battle_over() возвращает "victory"

#### test_battle_victory_enemy

- **Цель**: Проверка победы противника
- **Предусловия**: player_hp = 1
- **Действия**: Вызов enemy_turn() с атакой
- **Ожидаемый результат**: player_hp = 0, is_battle_over() возвращает "defeat"

#### test_battle_draw

- **Цель**: Проверка ничьей
- **Предусловия**: player_mp = 0, enemy_mp = 0, оба живы
- **Действия**: Проверка is_battle_over()
- **Ожидаемый результат**: Возвращает "draw"

#### test_battle_ongoing

- **Цель**: Проверка продолжения боя
- **Предусловия**: player_hp > 0, enemy_hp > 0, есть мана
- **Действия**: Проверка is_battle_over()
- **Ожидаемый результат**: Возвращает "ongoing"

### Тесты противников

#### test_start_battle_goblin

- **Цель**: Проверка инициализации боя с гоблином
- **Действия**: Вызов start_battle("goblin")
- **Ожидаемый результат**: enemy_name = "Гоблин", enemy_hp = 5, enemy_mp = 3

#### test_start_battle_orc

- **Цель**: Проверка инициализации боя с орком
- **Действия**: Вызов start_battle("orc")
- **Ожидаемый результат**: enemy_name = "Орк", enemy_hp = 8, enemy_mp = 2

#### test_start_battle_troll

- **Цель**: Проверка инициализации боя с троллем
- **Действия**: Вызов start_battle("troll")
- **Ожидаемый результат**: enemy_name = "Тролль", enemy_hp = 12, enemy_mp = 1

#### test_enemy_ai_actions

- **Цель**: Проверка ИИ противника
- **Предусловия**: Противник имеет достаточно маны
- **Действия**: Вызов enemy_turn()
- **Ожидаемый результат**: Противник выбирает одно из доступных действий

#### test_enemy_stream_attack

- **Цель**: Проверка "Атаки Потоком" противника
- **Предусловия**: enemy_mp ≥ 2, не под эффектом
- **Действия**: Вызов enemy_turn() с выбором "Атака Потоком"
- **Ожидаемый результат**: enemy_stream_attack_is_active = True, turns = 3

### Тесты интеграции

#### test_battle_cycle_complete

- **Цель**: Проверка полного цикла боя
- **Действия**: Выполнение полного боя до победы
- **Ожидаемый результат**: Корректное завершение боя с результатом

#### test_status_interactions

- **Цель**: Проверка взаимодействия статусов
- **Предусловия**: Множественные статусы активны
- **Действия**: Применение эффектов
- **Ожидаемый результат**: Корректное применение всех эффектов

#### test_variable_naming

- **Цель**: Проверка правильного именования переменных
- **Действия**: Проверка всех переменных "Атака Потоком"
- **Ожидаемый результат**: Использование правильных имен (player_stream_attack_is_active, enemy_stream_attack_is_active)

## Метрики тестирования

### Покрытие кода

- **Цель**: 100% покрытие боевой логики
- **Измерение**: Количество протестированных функций и веток кода

### Время выполнения

- **Цель**: Все тесты выполняются менее чем за 5 секунд
- **Измерение**: Общее время выполнения тестового набора

### Надежность

- **Цель**: 0 ложных срабатываний
- **Измерение**: Стабильность результатов тестов при повторных запусках

## Запуск тестов

### Автоматический запуск

```bash
python tests/test_battle_renpy.py
```

### Запуск отдельных тестов

```bash
python -m pytest tests/test_battle_renpy.py::test_specific_function
```

### Проверка покрытия

```bash
coverage run tests/test_battle_renpy.py
coverage report
```

## Поддержка тестов

### Обновление тестов

- При изменении боевой логики обновлять соответствующие тесты
- Добавлять новые тесты для новых функций
- Удалять устаревшие тесты

### Документирование

- Каждый тест должен иметь четкое описание цели
- Указывать предусловия и ожидаемые результаты
- Комментировать сложную логику тестов

### Регрессионное тестирование

- Запускать полный набор тестов перед каждым релизом
- Проверять совместимость с изменениями в других системах
- Отслеживать изменения в производительности
