# Боевая система - Тестирование

## Обзор тестирования

Тестирование боевой системы обеспечивает корректность работы ключевых механик. Все тесты должны быть написаны в файле `tests/test_battle_system.py` и копировать логику из `game/systems/battle_system.rpy`.

## Приоритеты тестирования

### Критически важные тесты (обязательные)

1. **Базовые механики атак и защиты**
2. **Статус "Атака Потоком"**
3. **Условия окончания боя**
4. **Инициализация противников**

### Важные тесты (рекомендуемые)

1. **Система переполнения**
2. **Лечение и щиты**
3. **Базовые проверки ИИ противника**

### Опциональные тесты

1. **Сложные интеграционные сценарии**
2. **Граничные случаи**
3. **Производительность**

## Ключевые тесты

### 1. Базовые механики

#### test_player_projectile_attack_basic

- **Цель**: Проверка базовой атаки снарядом
- **Предусловия**: Игрок имеет 1+ MP, противник жив
- **Действия**: Вызов player_projectile_attack()
- **Ожидаемый результат**: Противник получает 1 урон, игрок тратит 1 MP

#### test_player_projectile_attack_no_mana

- **Цель**: Проверка невозможности атаки без маны
- **Предусловия**: Игрок имеет 0 MP
- **Действия**: Вызов player_projectile_attack()
- **Ожидаемый результат**: Атака невозможна, возвращается сообщение об ошибке

#### test_player_projectile_attack_dead_enemy

- **Цель**: Проверка невозможности атаки мертвого противника
- **Предусловия**: HP противника ≤ 0
- **Действия**: Вызов player_projectile_attack()
- **Ожидаемый результат**: Возвращается "Противник уже побежден!", HP не изменяется

### 2. Статус "Атака Потоком"

#### test_stream_attack_activation

- **Цель**: Проверка активации "Атаки Потоком"
- **Предусловия**: Игрок имеет 2+ MP, не под эффектом
- **Действия**: Вызов player_stream_attack()
- **Ожидаемый результат**: player_stream_attack_is_active = True, turns = 3, тратит 2 MP

#### test_stream_attack_already_active

- **Цель**: Проверка невозможности повторной активации
- **Предусловия**: player_stream_attack_is_active = True
- **Действия**: Вызов player_stream_attack()
- **Ожидаемый результат**: Атака невозможна, возвращается сообщение об ошибке

#### test_stream_attack_effect_application

- **Цель**: Проверка применения эффекта "Атака Потоком"
- **Предусловия**: player_stream_attack_is_active = True, turns = 3
- **Действия**: Вызов apply_stream_attack_effect("player")
- **Ожидаемый результат**: Противник получает 1 урон, turns = 2

#### test_stream_attack_deactivation

- **Цель**: Проверка снятия статуса после 3 ходов
- **Предусловия**: player_stream_attack_is_active = True, turns = 1
- **Действия**: Вызов apply_stream_attack_effect("player")
- **Ожидаемый результат**: turns = 0, player_stream_attack_is_active = False

### 3. Условия боя

#### test_battle_victory_player

- **Цель**: Проверка победы игрока
- **Предусловия**: enemy_hp = 1
- **Действия**: Вызов player_projectile_attack()
- **Ожидаемый результат**: enemy_hp = 0, get_battle_result() возвращает "victory"

#### test_battle_victory_enemy

- **Цель**: Проверка победы противника
- **Предусловия**: player_hp = 1
- **Действия**: Вызов enemy_turn() с атакой
- **Ожидаемый результат**: player_hp = 0, get_battle_result() возвращает "defeat"

#### test_battle_ongoing

- **Цель**: Проверка продолжения боя
- **Предусловия**: player_hp > 0, enemy_hp > 0
- **Действия**: Проверка get_battle_result()
- **Ожидаемый результат**: Возвращает "ongoing"

### 4. Противники

#### test_start_battle_goblin

- **Цель**: Проверка инициализации боя с гоблином
- **Действия**: Вызов start_battle("goblin")
- **Ожидаемый результат**: enemy_name = "Гоблин", enemy_hp = 5, enemy_mp = 3

#### test_start_battle_orc

- **Цель**: Проверка инициализации боя с орком
- **Действия**: Вызов start_battle("orc")
- **Ожидаемый результат**: enemy_name = "Орк", enemy_hp = 8, enemy_mp = 2

#### test_start_battle_troll

- **Цель**: Проверка инициализации боя с троллем
- **Действия**: Вызов start_battle("troll")
- **Ожидаемый результат**: enemy_name = "Тролль", enemy_hp = 12, enemy_mp = 1

### 5. Защита и лечение

#### test_player_shield_spell

- **Цель**: Проверка создания щита
- **Предусловия**: Игрок имеет 1+ MP
- **Действия**: Вызов player_shield_spell()
- **Ожидаемый результат**: Игрок получает +1 щит, тратит 1 MP

#### test_player_heal

- **Цель**: Проверка лечения
- **Предусловия**: Игрок имеет 2+ MP
- **Действия**: Вызов player_heal()
- **Ожидаемый результат**: Игрок получает +2 HP, тратит 2 MP

### 6. Система переполнения

#### test_blood_overflow_activation

- **Цель**: Проверка активации переполнения кровью
- **Предусловия**: HP игрока > max_HP
- **Действия**: Вызов add_health("player", 5)
- **Ожидаемый результат**: player_blood_overflow = True

#### test_overflow_effects_application

- **Цель**: Проверка применения эффектов переполнения
- **Предусловия**: player_blood_overflow = True
- **Действия**: Вызов apply_overflow_effects("player")
- **Ожидаемый результат**: Игрок теряет 1 HP и теряет 2 MP

## Упрощенные требования

### Удаленные тесты

1. **Сложные интеграционные тесты** - заменены простыми проверками
2. **Детальные тесты ИИ** - заменены базовыми проверками
3. **Тесты производительности** - не критичны для небольшого проекта
4. **Метрики покрытия** - упрощены до базовых требований

### Упрощенные проверки

1. **Статусы переполнения** - только основные случаи
2. **Взаимодействие статусов** - упрощено
3. **Граничные случаи** - только критические

## Запуск тестов

### Автоматический запуск

```bash
python tests/test_battle_system.py
```

### Запуск отдельных тестов

```bash
python -m pytest tests/test_battle_system.py::test_specific_function
```

## Поддержка тестов

### Обновление тестов

- При изменении боевой логики обновлять соответствующие тесты
- Добавлять новые тесты только для критически важных функций
- Удалять устаревшие тесты

### Документирование

- Каждый тест должен иметь четкое описание цели
- Указывать предусловия и ожидаемые результаты
- Комментировать сложную логику тестов

### Минимальные требования

- Все критически важные тесты должны проходить
- Время выполнения: менее 10 секунд
- Стабильность результатов при повторных запусках
